<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure File Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/static/dashboard.css">
<meta name="theme-color" content="#1d72b8">
<style>

</style>
</head>
<body>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="flash-messages">
      {% for category, message in messages %}
        <div class="flash-box 
            {% if category == 'success' %}flash-success{% elif category == 'error' %}flash-error{% else %}flash-info{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
    <script>
      setTimeout(function(){
        document.querySelectorAll('.flash-box').forEach(function(el){
          el.style.opacity = '0';
          setTimeout(function(){ el.style.display = 'none'; }, 500);
        });
      }, 3000);
    </script>
  {% endif %}
{% endwith %}

<div class="container">
    <h2>Welcome, {{ session['user'] }}</h2>

    <h3>Upload a New File</h3>
    <form action="/upload" method="POST" enctype="multipart/form-data">
        <input type="file" name="file" required>
        <input type="text" name="custom_name" placeholder="Enter new filename (optional)">
        <button type="submit" class="btn btn-primary"><span>Upload</span></button>
    </form>

    <h3>My Uploaded Files</h3>
    {% if files %}
    <table>
        <thead>
            <tr>
                <th>Filename</th>
                <th>Preview</th>
                <th>Download</th>
                <th>Delete</th>
                <th>Details</th>
                <th>Rename</th>
            </tr>
        </thead>
        <tbody>
            {% for file in files %}
            <tr>
                <td data-label="Filename">{{ file.filename }}</td>
                <td data-label="Preview">
                    {% if file.filename.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.bmp')) %}
                    <button type="button" class="btn btn-primary" onclick="showPreview('/preview/{{ file.unique_id }}')"><span>Preview</span></button>
                    {% else %} â€” {% endif %}
                </td>
                <td data-label="Download">
                    <form action="/download" method="POST" target="_blank">
                        <input type="hidden" name="file_id" value="{{ file.unique_id }}">
                        <button class="btn btn-dark"><span>Download</span></button>
                    </form>
                </td>
                <td data-label="Delete">
                    <form action="/delete/{{ file.unique_id }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this file?');">
                        <button class="btn btn-light"><span>Delete</span></button>
                    </form>
                </td>
                <td data-label="Details">
                    <button type="button" class="btn btn-primary" onclick="showDetails('{{ file.unique_id }}', '{{ file.filename }}', '{{ (file.file_size / 1024) | round(2) }}', '{{ file.upload_time.strftime('%Y-%m-%d %H:%M:%S') }}')"><span>Details</span></button>
                </td>
                <td data-label="Rename">
                    <button type="button" class="btn btn-warning" onclick="openRenameModal('{{ file.unique_id }}', '{{ file.filename }}')"><span>Rename</span></button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>No files uploaded yet.</p>
    {% endif %}

    <a class="logout-link" href="/logout">Logout</a>
</div>

<!-- Image Preview Modal -->
<div id="imageModal" class="pre" onclick="if(event.target.id === 'imageModal') closeModal('imageModal')">
    <span class="pre-close" onclick="event.stopPropagation(); closeModal('imageModal')">&times;</span>
    <img class="pre-content" id="modalImage">
</div>

<!-- Details Modal -->
<div id="detailsModal" class="modal" onclick="if(event.target.id === 'detailsModal') closeModal('detailsModal')">
    <span class="modal-close" onclick="event.stopPropagation(); closeModal('detailsModal')">&times;</span>
    <div class="modal-content" style="background:#fff; padding:20px; border-radius:8px; max-width:400px; margin:auto;">
        <h3>File Details</h3>
        <p id="detailsText"></p>
    </div>
</div>

<!-- Rename Modal -->
<div id="renameModal" class="modal" onclick="if(event.target.id === 'renameModal') closeModal('renameModal')">
    <span class="modal-close" onclick="event.stopPropagation(); closeModal('renameModal')">&times;</span>
    <div class="modal-content">
        <h3>Rename File</h3>
        <form id="renameForm" method="POST">
            <input type="text" name="new_filename" id="new_filename" placeholder="Enter new filename" required>
            <br><br>
            <button type="submit" class="btn  btn-save ">Save</button>
        </form>
    </div>
</div>

<script>
    function showPreview(imageUrl) {
        var modal = document.getElementById("imageModal");
        var img = document.getElementById("modalImage");
        modal.style.display = "block";
        img.src = imageUrl;
    }
    function showDetails(id, name, size, uploaded) {
        var modal = document.getElementById("detailsModal");
        var text = document.getElementById("detailsText");
        text.innerHTML = "<strong>File ID:</strong> " + id + "<br>" +
                         "<strong>Filename:</strong> " + name + "<br>" +
                         "<strong>File Size:</strong> " + size + " KB<br>" +
                         "<strong>Uploaded On:</strong> " + uploaded;
        modal.style.display = "block";
    }
    function openRenameModal(unique_id, currentName) {
        document.getElementById('new_filename').value = currentName;
        document.getElementById('renameForm').action = '/rename/' + unique_id;
        document.getElementById('renameModal').style.display = 'block';
    }
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
    }
    function enableSwipeClose(modalId) {
        let startX, startY, endX, endY;
        const modal = document.getElementById(modalId);
        modal.addEventListener('touchstart', e => {
            const touch = e.touches[0];
            startX = touch.clientX; startY = touch.clientY;
        }, false);
        modal.addEventListener('touchmove', e => {
            const touch = e.touches[0];
            endX = touch.clientX; endY = touch.clientY;
        }, false);
        modal.addEventListener('touchend', () => {
            if (Math.abs(endY - startY) > 100 || Math.abs(endX - startX) > 100) {
                closeModal(modalId);
            }
        }, false);
    }
    enableSwipeClose("imageModal");
    enableSwipeClose("detailsModal");
    enableSwipeClose("renameModal");
</script>
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/static/service-worker.js')
    .then(() => console.log('Service Worker Registered'));
}
</script>

</body>
</html>
